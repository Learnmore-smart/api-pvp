<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API PVP â€“ Arena</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    height: 100%;
    background: #0a0a1a;
    color: #e0e0e0;
    font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    overflow: hidden;
  }
  body { display: flex; flex-direction: column; }
  #header {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 20px;
    background: #12122a;
    border-bottom: 2px solid #2a2a5a;
  }
  #header h1 { font-size: 1.3em; color: #7c7cff; letter-spacing: 2px; }
  #mode-badge {
    padding: 4px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .mode-test,
  .mode-sandbox,
  .mode-lobby    { background: #264653; color: #a8dadc; }
  .mode-battle   { background: #9b2226; color: #ffc2c2; }
  .mode-finished { background: #e9c46a; color: #1d1d1d; }
  #tick-info { font-size: 0.85em; color: #888; }
  #main {
    flex: 1;
    min-height: 0;
    display: flex;
    overflow: hidden;
  }
  #canvas-wrap {
    flex: 1;
    min-height: 0;
    min-width: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    overflow: hidden;
  }
  canvas {
    background: #111122;
    border: 2px solid #2a2a5a;
    border-radius: 6px;
    display: block;
    max-width: 100%;
    max-height: 100%;
  }
  /* Lobby full-canvas overlay */
  #lobby-overlay {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: #111122;
    border: 2px solid #2a2a5a;
    border-radius: 6px;
    gap: 14px;
  }
  #lobby-overlay h2 { color: #7c7cff; font-size: 1.8em; letter-spacing: 3px; }
  #lobby-overlay .sub { color: #555; font-size: 0.9em; }
  #lobby-player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 8px; }
  .lobby-card {
    background: #1a1a35;
    border-radius: 8px;
    padding: 10px 20px;
    min-width: 140px;
    text-align: center;
    border-left: 4px solid #555;
  }
  .lobby-card .lname { font-weight: bold; font-size: 1em; margin-bottom: 4px; }
  .lobby-card .lstatus { font-size: 0.75em; }
  .ready-yes { color: #2ecc71; }
  .ready-no  { color: #888; }

  #sidebar {
    width: 250px;
    flex-shrink: 0;
    background: #12122a;
    border-left: 2px solid #2a2a5a;
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #sidebar h2 { font-size: 1em; color: #7c7cff; border-bottom: 1px solid #2a2a5a; padding-bottom: 6px; }
  .player-card {
    background: #1a1a35;
    border-radius: 6px;
    padding: 8px 10px;
    border-left: 3px solid #555;
  }
  .player-card.dead { opacity: 0.4; }
  .player-name  { font-weight: bold; font-size: 0.9em; margin-bottom: 4px; }
  .player-stat  { font-size: 0.75em; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 2px; }
  .hp-bar       { height: 6px; background: #333; border-radius: 3px; margin-top: 4px; overflow: hidden; }
  .hp-bar-fill  { height: 100%; border-radius: 3px; transition: width 0.15s; }
  #controls { border-top: 1px solid #2a2a5a; padding-top: 10px; display: flex; flex-direction: column; gap: 6px; }
  #controls button {
    padding: 8px;
    background: #2a2a5a;
    color: #ccc;
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
  }
  #controls button:hover { background: #3a3a6a; }
  #controls button.primary { background: #2d6a4f; border-color: #3a8; color: #b7e4c7; }
  #controls button.primary:hover { background: #3d7a5f; }
  #winner-banner {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.93);
    padding: 40px 60px;
    border-radius: 16px;
    border: 3px solid #e9c46a;
    text-align: center;
    z-index: 100;
  }
  #winner-banner h2 { color: #e9c46a; font-size: 2em; margin-bottom: 10px; }
  #winner-banner p  { color: #ccc; font-size: 1.1em; }
  #winner-banner button {
    margin-top: 16px; padding: 8px 24px;
    background: #333; color: #ccc;
    border: 1px solid #555; border-radius: 4px; cursor: pointer;
  }
</style>
</head>
<body>

<div id="header">
  <h1>âš”ï¸ API PVP ARENA</h1>
  <span id="mode-badge" class="mode-lobby">LOBBY</span>
  <span id="tick-info">Tick: 0</span>
</div>

<div id="main">
  <div id="canvas-wrap">
    <!-- Battle arena canvas -->
    <canvas id="arena" style="display:none"></canvas>
    <!-- Lobby overlay (shown when no battle) -->
    <div id="lobby-overlay">
      <h2>âš”ï¸ API PVP</h2>
      <div class="sub">Waiting for battle to startâ€¦</div>
      <div id="lobby-player-list"></div>
      <div class="sub" id="lobby-ready-status" style="margin-top:4px"></div>
    </div>
  </div>

  <div id="sidebar">
    <h2>Players</h2>
    <div id="player-list"></div>
    <div id="controls">
      <button class="primary" onclick="startBattle()">â–¶ Start Battle</button>
      <button onclick="resetGame()">â†» Reset to Sandbox</button>
    </div>
  </div>
</div>

<div id="winner-banner">
  <h2>ğŸ† <span id="winner-name"></span></h2>
  <p id="winner-stats"></p>
  <button onclick="this.parentElement.style.display='none'">Close</button>
</div>

<script>
const arenaCanvas = document.getElementById('arena');
const ctx = arenaCanvas.getContext('2d');
const CELL = 24;

let state = null;

// â”€â”€ Canvas resize â€” only on explicit resize, never inside render â”€â”€
function resizeArenaCanvas() {
  if (!state?.arena) return;
  const wrap = document.getElementById('canvas-wrap');
  const a = state.arena;
  const maxW = wrap.clientWidth  - 20;
  const maxH = wrap.clientHeight - 20;
  const scale = Math.min(maxW / (a.width * CELL), maxH / (a.height * CELL), 1.5);
  arenaCanvas.width  = Math.floor(a.width  * CELL * scale);
  arenaCanvas.height = Math.floor(a.height * CELL * scale);
  arenaCanvas._scale = scale;
}

window.addEventListener('resize', resizeArenaCanvas);

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
let ws;

function connectWS() {
  ws = new WebSocket(`${wsProtocol}//${location.host}?type=bigscreen`);
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'state') {
      state = msg.data;
      tick();
    }
  };
  ws.onclose = () => setTimeout(connectWS, 1000);
  ws.onerror = () => ws.close();
}
connectWS();

function tick() {
  updateHeader();
  if (state.mode === 'lobby' || !state.arena) {
    showLobby();
  } else {
    showArena();
    render();
  }
  updateSidebar();
}

// â”€â”€ Lobby view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLobby() {
  arenaCanvas.style.display = 'none';
  document.getElementById('lobby-overlay').style.display = 'flex';

  const players = state.players || [];
  const list = document.getElementById('lobby-player-list');
  list.innerHTML = players.map(p => `
    <div class="lobby-card" style="border-left-color:${p.color || '#7c7cff'}">
      <div class="lname" style="color:${p.color || '#7c7cff'}">${p.username}</div>
      <div class="lstatus ${p.ready ? 'ready-yes' : 'ready-no'}">${p.ready ? 'âœ“ Ready' : 'â—‹ Not ready'}</div>
    </div>
  `).join('') || '<div style="color:#444">No players yet</div>';

  const readyCount = players.filter(p => p.ready).length;
  document.getElementById('lobby-ready-status').textContent =
    players.length ? `${readyCount} / ${players.length} ready` : '';
}

// â”€â”€ Arena view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showArena() {
  document.getElementById('lobby-overlay').style.display = 'none';
  arenaCanvas.style.display = 'block';
  if (!arenaCanvas._scale) resizeArenaCanvas();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!state?.arena) return;
  const s = arenaCanvas._scale || 1;
  const a = state.arena;

  ctx.clearRect(0, 0, arenaCanvas.width, arenaCanvas.height);

  // Grid
  ctx.strokeStyle = '#1a1a30';
  ctx.lineWidth = 0.5;
  for (let x = 0; x <= a.width; x++) {
    ctx.beginPath();
    ctx.moveTo(x * CELL * s, 0);
    ctx.lineTo(x * CELL * s, a.height * CELL * s);
    ctx.stroke();
  }
  for (let y = 0; y <= a.height; y++) {
    ctx.beginPath();
    ctx.moveTo(0, y * CELL * s);
    ctx.lineTo(a.width * CELL * s, y * CELL * s);
    ctx.stroke();
  }

  // Obstacles
  for (const obs of a.obstacles) {
    ctx.fillStyle   = obs.type === 'wall' ? '#3a3a5a' : '#5a4a2a';
    ctx.strokeStyle = obs.type === 'wall' ? '#5a5a8a' : '#8a7a4a';
    ctx.lineWidth   = 1;
    ctx.fillRect  (obs.x * CELL * s, obs.y * CELL * s, obs.w * CELL * s, obs.h * CELL * s);
    ctx.strokeRect(obs.x * CELL * s, obs.y * CELL * s, obs.w * CELL * s, obs.h * CELL * s);
  }

  // Projectiles
  for (const p of (state.projectiles || [])) {
    const px = p.x * CELL * s;
    const py = p.y * CELL * s;
    ctx.fillStyle   = '#ffdd44';
    ctx.shadowColor = '#ffdd44';
    ctx.shadowBlur  = 6 * s;
    ctx.beginPath();
    ctx.arc(px, py, 3 * s, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,221,68,0.3)';
    ctx.lineWidth   = 2 * s;
    ctx.beginPath();
    ctx.moveTo(px, py);
    ctx.lineTo(px - p.dx * CELL * s * 0.4, py - p.dy * CELL * s * 0.4);
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  // Players
  for (const p of (state.players || [])) {
    const px = p.x * CELL * s;
    const py = p.y * CELL * s;
    const r  = 0.4 * CELL * s;

    if (!p.alive) {
      ctx.strokeStyle = '#555';
      ctx.lineWidth   = 2;
      ctx.beginPath();
      ctx.moveTo(px - r*0.6, py - r*0.6); ctx.lineTo(px + r*0.6, py + r*0.6);
      ctx.moveTo(px + r*0.6, py - r*0.6); ctx.lineTo(px - r*0.6, py + r*0.6);
      ctx.stroke();
      continue;
    }

    if (p.shielded) {
      ctx.strokeStyle = 'rgba(100,180,255,0.7)';
      ctx.lineWidth   = 3 * s;
      ctx.beginPath();
      ctx.arc(px, py, r + 4 * s, 0, Math.PI * 2);
      ctx.stroke();
    }

    ctx.fillStyle = p.color || '#3498db';
    ctx.beginPath();
    ctx.arc(px, py, r, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth   = 1.5;
    ctx.beginPath();
    ctx.arc(px, py, r, 0, Math.PI * 2);
    ctx.stroke();

    ctx.fillStyle  = '#fff';
    ctx.font       = `${Math.max(9, 11 * s)}px sans-serif`;
    ctx.textAlign  = 'center';
    ctx.fillText(p.username, px, py - r - 6 * s);

    const bW = r * 2.2, bH = 3 * s;
    const bX = px - bW / 2, bY = py + r + 4 * s;
    ctx.fillStyle = '#333';
    ctx.fillRect(bX, bY, bW, bH);
    const hpP = p.hp / 100;
    ctx.fillStyle = hpP > 0.5 ? '#2ecc71' : hpP > 0.25 ? '#f1c40f' : '#e74c3c';
    ctx.fillRect(bX, bY, bW * hpP, bH);
  }

  // Winner
  if (state.mode === 'finished' && state.winner) {
    const b = document.getElementById('winner-banner');
    document.getElementById('winner-name').textContent  = state.winner.username + ' Wins!';
    document.getElementById('winner-stats').textContent = `HP: ${state.winner.hp}  |  Kills: ${state.winner.kills}`;
    b.style.display = 'block';
  }
}

// â”€â”€ Header + sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeader() {
  const badge = document.getElementById('mode-badge');
  badge.textContent = state.mode.toUpperCase();
  badge.className   = `mode-${state.mode}`;
  document.getElementById('tick-info').textContent = `Tick: ${state.tick}`;
}

function updateSidebar() {
  const players = (state.players || []).slice().sort((a, b) => b.hp - a.hp);
  document.getElementById('player-list').innerHTML = players.map(p => `
    <div class="player-card ${p.alive === false ? 'dead' : ''}" style="border-left-color:${p.color || '#555'}">
      <div class="player-name" style="color:${p.color || '#ccc'}">${p.username} ${p.shielded ? 'ğŸ›¡ï¸' : ''}</div>
      <div class="player-stat"><span>HP</span><span>${p.hp ?? 100}/100</span></div>
      <div class="hp-bar"><div class="hp-bar-fill" style="width:${p.hp ?? 100}%;background:${(p.hp??100) > 50 ? '#2ecc71' : (p.hp??100) > 25 ? '#f1c40f' : '#e74c3c'}"></div></div>
      <div class="player-stat"><span>Ammo</span><span>${p.ammo ?? 'â€”'}</span></div>
      <div class="player-stat"><span>Energy</span><span>${p.energy ?? 'â€”'}</span></div>
      <div class="player-stat"><span>Ready</span><span>${p.ready ? 'âœ“' : 'â€”'}</span></div>
      ${p.alive === false ? '<div style="color:#e74c3c;font-size:0.75em;margin-top:3px">â˜  ELIMINATED</div>' : ''}
    </div>
  `).join('');
}

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startBattle() {
  await fetch('/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
}

async function resetGame() {
  document.getElementById('winner-banner').style.display = 'none';
  await fetch('/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
  arenaCanvas._scale = null; // force re-measure on next arena render
}
</script>
</body>
</html>
